library(tidyverse)
library(psych)
library(car)
library(lavaan)
library(semPlot)



LBCtest %>%
  describe %>%
  as.data.frame() %>%
  rownames_to_column(., var = "variable")%>%
  select(variable, mean, sd, skew, kurtosis)%>%
  kable(digits = 2)%>%
  kable_styling(full_width = F)

LBCtest %>%
  pivot_longer(2:11, names_to = "variable", values_to="score") %>%
  ggplot(aes(x=score))+
  geom_density()+
  facet_wrap(~variable)+
  theme_light()



#RMSEA, SRMR .05; TLI, CFI .95
#CFA

modelcholes <- '
choles =~ bld_choles_w1 + bld_hdlchol_w1 + bld_hdlrat_w1 + bld_triglyc_w1 + hichol_w1

choles ~ lonely_w1
'
modelfitcholes <- cfa(modelcholes, LBC1936, std.lv = T)
summary(modelfitcholes, fit = T, standardized = T)
modindices(modelfitcholes, sort = T)

modelbp <-'
dbp =~ dbp1sit_w1 + dbp2sit_w1 + dbp3sit_w1
sbp =~ sbp1sit_w1 + sbp2sit_w1 + sbp3sit_w1

bp =~ dbp + sbp + hibp_w1'
modelfitbp <- cfa(modelbp, LBC1936, std.lv = T)
summary(modelfitbp, fit = T, standardized = T)
modindices(modelfitbp, sort = T)
semPaths(modelfitbp, what="paths")

modelcardio <-'cardio =~ bld_crprot_w1 + cvdhist_w1
cardio ~ lonely_w1
'
modelfitcardio <- cfa(modelcardio, LBC1936, std.lv = T)
summary(modelfitcardio, fit = T, standardized = T)
modindices(modelfitcardio, sort = T)

modeldiab <-'diab =~ bld_hba1c_w1 + diab_w1
diab ~ lonely_w1'
modelfitdiab <- cfa(modeldiab, LBC1936, std.lv = T)
summary(modelfitdiab, fit = T, standardized = T)
modindices(modelfitdiab, sort = T)

modelstroke <-'stroke =~ stroke_mask_w2
stroke ~ lonely_w1'
modelfitstroke <- cfa(modelstroke, LBC1936, std.lv = T)
summary(modelfitstroke, fit = T, standardized = T)
modindices(modelfitstroke, sort = T)


modeldemen <-'dementia =~ dementia_code
dementia ~ lonely_w1'
modelfitdemen <- cfa(modeldemen, LBC1936, std.lv = T)
summary(modelfitdemen, fit = T, standardized = T)
modindices(modelfitdemen, sort = T)

#SEM 

semmodel_w1 <- '

#cholesterol
choles =~ bld_choles_w1 + bld_hdlchol_w1 + bld_hdlrat_w1 + hichol_w1 + bld_triglyc_w1

#cardiovascular disease
cardio =~ bld_crprot_w1 + cvdhist_w1

#blood pressure
dbp =~ dbp1sit_w1 + dbp2sit_w1 + dbp3sit_w1
sbp =~ sbp1sit_w1 + sbp2sit_w1 + sbp3sit_w1

bp =~ dbp + sbp + hibp_w1

#diabetes
diab =~ bld_hba1c_w1 + diab_w1

#strokes
stroke =~ stroke_mask_w2

#dementia
dementia =~ dementia_code          

#chronic health index 
risk =~ choles + bp + diab + dementia + stroke + cardio

risk ~ c*lonely_w1
risk ~ livealn_w1
risk ~ hiqual_w1
risk ~ sex

risk ~ b*phyactiv_w1

phyactiv_w1 ~ a*lonely_w1


#Indirect
ind:=a*b

#Total
Total:=c+a*b



#Modindices
hichol_w1 ~~     cvdhist_w1
hichol_w1 ~~        hibp_w1
hichol_w1 ~~ diab_w1
cvdhist_w1 ~~        hibp_w1
hibp_w1 ~~ diab_w1


lonely_w1 ~~ bp 
lonely_w1 ~~ choles
lonely_w1 ~~ cardio
lonely_w1 ~~ stroke
lonely_w1 ~~ diab
lonely_w1 ~~ dementia

'

sem_model_w1 <- sem(semmodel_w1, LBC1936, 
                    missing = 'FIML')
summary(sem_model_w1, fit.measures = T, standardized =T, ci = T)
modindices(sem_model_w1, sort = T)
